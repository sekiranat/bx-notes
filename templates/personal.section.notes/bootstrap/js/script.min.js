!function(){"use strict";function a(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var e=function(){function t(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),this.pageBlock=document.getElementById("personal-section-notes"),this.modal=!1,this.isMobile=BX.browser.IsMobile(),this.productId=!1,this.itemFavoriteId=!1,this.userRating=!1,this.helperInstance=window.commonHelperComponent||null,BX.UI.Notification.Center.setStackDefaults("bottom-right",{offsetX:100}),BX.UI.Notification.Center.setStackDefaults("top-center",{offsetY:200})}var e,r,n;return e=t,(r=[{key:"init",value:function(){this.calculateCardInnerHeights(),this.setScrollBar(),this.setListeners()}},{key:"setListeners",value:function(){var r=this;document.addEventListener("click",function(e){r.clickEvent(e)}),document.addEventListener("input",function(e){r.inputEvent(e)}),window.addEventListener("resize",function(){r.calculateCardInnerHeights()}),this.pageBlock&&this.pageBlock.querySelector(".card")&&this.pageBlock.querySelectorAll(".card").forEach(function(e){e.querySelector(".card-user-rating").querySelectorAll(".icon").forEach(function(e){e.addEventListener("mouseenter",function(e){return r.mouseEnterRating(e)}),e.addEventListener("mouseleave",function(e){return r.mouseLeaveRating(e)}),e.addEventListener("click",function(e){return r.ratingVote(e)})})}),document.addEventListener("mouseover",function(e){return r.mouseOverOnModal(e)}),document.addEventListener("mouseout",function(e){return r.mouseOutOnModal(e)}),document.addEventListener("submit",function(e){return r.submitRatingVoteModal(e)}),document.addEventListener("modal:shown",function(e){window.__debug&&console.log(e,e.data),e.data.modal&&(r.modal=e.data.modal,r.modal.querySelector(".rating")&&(r.modal.querySelector(".rating").classList.add("allow"),0<r.userRating&&r.modal.querySelector(".rating").querySelectorAll("svg").forEach(function(e,t){r.userRating>=t+1&&e.classList.add("hovered","active")}),r.modal.querySelector(".rating").addEventListener("click",r.clickOnModal)))}),document.addEventListener("modal:hidden",function(e){window.__debug&&console.log(e,e.data),e.data.modal&&(r.modal.querySelector(".rating")&&r.modal.querySelector(".rating").removeEventListener("click",r.clickOnModal),r.modal=void 0)})}},{key:"setScrollBar",value:function(){OverlayScrollbars(this.pageBlock.querySelectorAll(".overflow-custom"),{})}},{key:"clickEvent",value:function(e){var t=e.target,r=t&&t.getAttribute("data-id")?t.getAttribute("data-id"):null;if(t.hasAttribute("data-href")&&t.getAttribute("data-href")&&(location.href=t.getAttribute("data-href")),!r)return!1;switch(r){case"edit-note":this.editSortNote(t);break;case"save-note":this.saveSortNote(t);break;case"remove-note":this.removeSortNote(t)}}},{key:"inputEvent",value:function(e){var t=e.target,r=t?t.closest("[data-id=note-edit-block]"):null;if(!r)return!1;r.nextElementSibling&&(t.value&&0!==t.value.length?r.nextElementSibling.classList.remove("button-disabled"):t.value===t.defaultValue&&r.nextElementSibling.classList.add("button-disabled"))}},{key:"calculateCardInnerHeights",value:function(){document.querySelectorAll('[data-entity="items-row"]').forEach(function(e){var n,a,o=e.querySelectorAll(".card"),t=(t=e.getBoundingClientRect()).width,r=(r=o[0].getBoundingClientRect()).width,i=Math.floor(t/r);1===i||isNaN(i)||(n=[],a=[],o.forEach(function(e,t){var r=t+1;a.push(e),r%i!=0&&r!==o.length||(n.push(a),a=[])}),n.forEach(function(e){var r=e.map(function(e){var t={},r=e.querySelector(".card-marks-list");return t.marks=r&&0<r.textContent.length?r.getBoundingClientRect().height:0,r=e.querySelector('[data-block-id="product-name"]'),t.name=r&&0<r.textContent.length?r.getBoundingClientRect().height:0,r=e.querySelector(".sub-name"),t.subName=r&&0<r.textContent.length?r.getBoundingClientRect().height:0,r=e.querySelector('[data-block-id="bought-times"]'),t.boughtTimes=r&&0<r.textContent.length?r.getBoundingClientRect().height:0,r=e.querySelector(".card-desc"),t.desc=r&&0<r.textContent.length?r.getBoundingClientRect().height:0,r=e.querySelector(".card-scales .row"),t.scale=r&&2<r.querySelectorAll(".col-6").length?r.getBoundingClientRect().height:0,t}).reduce(function(t,r){var n={};return["marks","name","subName","boughtTimes","desc","scale"].forEach(function(e){n[e]=t[e]||0,r.hasOwnProperty(e)&&n[e]<=r[e]&&(n[e]=r[e])}),n});e.forEach(function(e){var t=e.querySelector(".card-marks-list");t&&(t.style.minHeight=(r.marks?r.marks:0)+"px",e.classList.contains("card-cocoa")&&(t.style.minHeight="18px")),(t=e.querySelector('[data-block-id="product-name"]'))&&(t.style.minHeight=(r.name?r.name:0)+"px"),(t=e.querySelector(".sub-name"))&&(t.style.minHeight=(r.subName?r.subName:0)+"px"),(t=e.querySelector('[data-block-id="bought-times"]'))&&(t.style.minHeight=(r.boughtTimes?r.boughtTimes:0)+"px"),(t=e.querySelector(".card-desc"))&&(t.style.minHeight=(r.desc?r.desc:0)+"px"),(t=e.querySelector(".card-scales .row"))&&(t.style.minHeight=(r.scale?r.scale:0)+"px")})}))})}},{key:"editSortNote",value:function(e){if(!e)return!1;var t=e.closest("[data-id=note-item]");t&&(t.querySelector("[data-id=note-text]")&&(t.querySelector("[data-id=note-text]").hidden=!0),t.querySelector("[data-id=note-edit-block]")&&(t.querySelector("[data-id=note-edit-block]").hidden=!1),e.setAttribute("data-id","save-note"),e.innerText="Сохранить")}},{key:"saveSortNote",value:function(t){var r=this;if(!t)return!1;var e,n=t.closest("[data-id=note-item]"),a=!!n.hasAttribute("data-item-id")&&n.getAttribute("data-item-id"),o="";n&&n.querySelector("[data-id=note-edit-block]")&&n.querySelector("[data-id=note-edit-block]").querySelector("textarea")&&(o=n.querySelector("[data-id=note-edit-block]").querySelector("textarea").value,e=n.querySelector("[data-id=note-edit-block]").querySelector("textarea").defaultValue),n&&(0!==o.length||o!==e)&&a?(this.helperInstance&&this.helperInstance.initPreloader(),BX.ajax({url:this.buildUrlQuery("saveNote"),method:"POST",dataType:"json",data:{id:a,text:o},onsuccess:function(e){"string"==typeof e&&(e=JSON.parse(e)),window.__debug&&console.log(e),r.helperInstance&&r.helperInstance.removePreloader(),e.hasOwnProperty("status")?"error"===e.status?r.helperInstance.handleCommonErrors(e.errors):(e.hasOwnProperty("data")&&e.data.hasOwnProperty("RECORD_ID")&&!n.dataset.elementId&&(n.dataset.elementId=e.data.RECORD_ID),0!==o.length?(n.querySelector("[data-id=note-edit-block]")&&(n.querySelector("[data-id=note-edit-block]").hidden=!0),n.querySelector("[data-id=note-text]")&&(n.querySelector("[data-id=note-text]").hidden=!1,n.querySelector("[data-id=note-text]").querySelector(".os-content")?n.querySelector("[data-id=note-text]").querySelector(".os-content").innerHTML=o:n.querySelector("[data-id=note-text]").innerHTML=o,145<o.length&&n.querySelector("[data-id=note-text]").classList.add("note-size-1"),190<o.length&&(n.querySelector("[data-id=note-text]").classList.add("overflow-custom"),OverlayScrollbars(n.querySelector("[data-id=note-text]"),{}))),t.setAttribute("data-id","edit-note"),t.innerText="Редактировать"):t.classList.add("button-disabled"),r.helperInstance.handleNotify("Заметка обновлена")):r.helperInstance.handleCommonErrors(["Произошла непредвиденная ошибка. Пожалуйста, попробуйте позже или свяжитесь с нами"])},onfailure:function(){r.helperInstance&&r.helperInstance.removePreloader(),r.helperInstance.handleCommonErrors(["Произошла непредвиденная ошибка. Пожалуйста, попробуйте позже или свяжитесь с нами"])}})):(n.querySelector("[data-id=note-edit-block]")&&(n.querySelector("[data-id=note-edit-block]").hidden=!0),n.querySelector("[data-id=note-text]")&&(n.querySelector("[data-id=note-text]").hidden=!1,n.querySelector("[data-id=note-text]").querySelector(".os-content")?n.querySelector("[data-id=note-text]").querySelector(".os-content").innerHTML=o:n.querySelector("[data-id=note-text]").innerHTML=o),t.setAttribute("data-id","edit-note"),t.innerText="Редактировать")}},{key:"removeSortNote",value:function(e){var t=this;if(!e)return!1;var r,n=e.closest("[data-id=note-item]");n&&((r=!!n.hasAttribute("data-item-id")&&n.getAttribute("data-item-id"))?(this.helperInstance&&this.helperInstance.initPreloader(),BX.ajax({url:this.buildUrlQuery("removeNote"),method:"POST",dataType:"json",data:{id:r},onsuccess:function(e){"string"==typeof e&&(e=JSON.parse(e)),window.__debug&&console.log(e),t.helperInstance&&t.helperInstance.removePreloader(),e.hasOwnProperty("status")?"error"===e.status?t.helperInstance.handleCommonErrors(e.errors):(n.style.opacity=0,setTimeout(function(){n.remove(),t.calculateCardInnerHeights()},400),t.helperInstance.handleNotify("Сорт удален из избранного")):t.helperInstance.handleCommonErrors(["Произошла непредвиденная ошибка. Пожалуйста, попробуйте позже или свяжитесь с нами"])},onfailure:function(){t.helperInstance&&t.helperInstance.removePreloader(),t.helperInstance.handleCommonErrors(["Произошла непредвиденная ошибка. Пожалуйста, попробуйте позже или свяжитесь с нами"])}})):(n.querySelector("[data-id=note-edit-block]")&&(n.querySelector("[data-id=note-edit-block]").hidden=!0),n.querySelector("[data-id=note-text]")&&(n.querySelector("[data-id=note-text]").hidden=!1,n.querySelector("[data-id=note-text]").querySelector(".os-content")?n.querySelector("[data-id=note-text]").querySelector(".os-content").innerHTML=text:n.querySelector("[data-id=note-text]").innerHTML=text),e.setAttribute("data-id","edit-note"),e.innerText="Редактировать"))}},{key:"mouseEnterRating",value:function(e){var t=e.target,r=[];if(BX.findParent(t,{class:"card-rating"})){r.push(t);for(var n=t.previousElementSibling;n;)r.push(n),n=n.previousElementSibling;0!==r.length&&r.forEach(function(e){return e.classList.add("hovered")})}}},{key:"mouseLeaveRating",value:function(e){var t=e.target,r=[];if(BX.findParent(t,{class:"card-rating"})){r.push(t);for(var n=t.previousElementSibling;n;)r.push(n),n=n.previousElementSibling;0!==r.length&&r.forEach(function(e){return e.classList.remove("hovered")})}}},{key:"mouseLeaveRatingModal",value:function(e){var t=e.target,r=BX.findParent(t,{class:"rating"}),n=[];if(r&&r.classList.contains("allow")){if(e.dropAll)r.querySelectorAll("svg").forEach(function(e){return n.push(e)});else for(var a=t.nextElementSibling;a;)n.push(a),a=a.nextElementSibling;0!==n.length&&n.forEach(function(e){return e.classList.remove("hovered")})}}},{key:"ratingVote",value:function(e){var t=e.target,r=BX.findParent(t,{class:"card-rating"});r?(this.productId=!!r.closest(".card")&&r.closest(".card").getAttribute("data-sort-id"),this.itemFavoriteId=!!r.closest(".card")&&r.closest(".card").getAttribute("data-item-id"),this.userRating=r.querySelector(".stars").querySelectorAll("svg.hovered").length):(e.preventDefault(),e.stopPropagation())}},{key:"submitRatingVoteModal",value:function(e){var a,t,o=this,r=e.target,i=this.modal?this.modal.querySelector(".modal-wrap").firstElementChild:void 0;if(e.preventDefault(),!r||!r.closest(".modal")||"product-rating"!==r.name)return!1;r.querySelector(".rating")&&(a=r.querySelector(".rating").querySelectorAll("svg.active").length,t=this.itemFavoriteId,this.helperInstance&&this.helperInstance.initPreloader(i),BX.ajax({url:this.buildUrlQuery("setUserRating"),method:"POST",dataType:"json",data:{id:t,rating:a},onsuccess:function(e){var t,r,n;"string"==typeof e&&(e=JSON.parse(e)),window.__debug&&console.log(e),o.helperInstance&&o.helperInstance.removePreloader(i),e.hasOwnProperty("status")?"error"===e.status?o.helperInstance.handleCommonErrors(e.errors):(o.pageBlock.querySelector('[data-sort-id="'+o.productId+'"]')&&(t=o.pageBlock.querySelector('[data-sort-id="'+o.productId+'"]'),e.hasOwnProperty("data")&&e.data.hasOwnProperty("RECORD_ID")&&!t.dataset.elementId&&(t.dataset.elementId=e.data.RECORD_ID),t.querySelector(".card-user-rating").querySelectorAll("svg").forEach(function(e,t){e.classList.remove("active"),Math.floor(a)>=t+1&&e.classList.add("active")})),r=new Event("click",{bubbles:!0,cancelable:!0}),o.modal.querySelector(".submit-block").classList.add("text-center"),o.modal.querySelector(".submit-block [type=submit]").hidden=!0,(n=document.createElement("div")).classList.add("mt-20","mb-10"),n.setAttribute("data-id","notify-text"),n.innerText="Спасибо, ваша оценка успешно установлена.",o.modal.querySelector(".submit-block").appendChild(n),setTimeout(function(){o.modal.querySelector(".submit-block [data-id=notify-text]").remove(),o.modal.querySelector(".submit-block [type=submit]").hidden=!1,o.modal.querySelector("[data-close]").dispatchEvent(r)},1500),o.helperInstance.handleNotify("Оценка успешно установлена")):o.helperInstance.handleCommonErrors(["Произошла непредвиденная ошибка. Пожалуйста, попробуйте позже или свяжитесь с нами"])},onfailure:function(){o.helperInstance&&o.helperInstance.removePreloader(i),o.helperInstance.handleCommonErrors(["Произошла непредвиденная ошибка. Пожалуйста, попробуйте позже или свяжитесь с нами"])}}))}},{key:"mouseOverOnModal",value:function(e){var t,r=e.target;if(!r||!r.closest(".modal")||!r.closest(".rating"))return!1;r&&r.closest("svg")&&(t={target:r.closest("svg")},this.mouseEnterRating(t))}},{key:"mouseOutOnModal",value:function(e){var t=e.target;if(!t||!t.closest(".modal")||!t.closest(".rating"))return!1;var r={target:t.closest("svg")};e.relatedTarget&&e.relatedTarget.closest(".stars")||(r.dropAll=!0),this.mouseLeaveRatingModal(r)}},{key:"clickOnModal",value:function(e){var t=e.target;if(t&&t.closest("svg")){var r=[];t.closest(".stars").querySelectorAll("svg").forEach(function(e){return e.classList.remove("active")}),r.push(t.closest("svg"));for(var n=t.closest("svg").previousElementSibling;n;)r.push(n),n=n.previousElementSibling;0!==r.length&&r.forEach(function(e){return e.classList.add("active")})}}},{key:"buildUrlQuery",value:function(e,t){var r={c:"tf:personal.section.notes",mode:"ajax"};for(var n in e&&0!==e.length||(e="stub"),r.action=e,t)t.hasOwnProperty(n)&&(r[n]=t[n]);return"/bitrix/services/main/ajax.php?"+$.param(r,!0)}},{key:"preventDefaults",value:function(e){e.preventDefault(),e.stopPropagation()}}])&&a(e.prototype,r),n&&a(e,n),Object.defineProperty(e,"prototype",{writable:!1}),t}();document.addEventListener("DOMContentLoaded",function(){window.PersonalSectionNotesComponent=new e,window.PersonalSectionNotesComponent.init()})}();